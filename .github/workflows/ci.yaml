# Copyright 2026 The OpenChoreo Authors
# SPDX-License-Identifier: Apache-2.0

name: Build Images and Release Charts

on:
  push:
    branches: [main]
    paths:
      - "**/init/**"
      - "**/helm/**"
      - "**/module.yaml"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR (Docker)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to GHCR (Helm)
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username "${{ github.actor }}" --password-stdin

      - name: Build images and release charts
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          BEFORE_SHA="${{ github.event.before }}"

          # Determine changed files
          if [ -n "$BEFORE_SHA" ] && [ "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
            CHANGED_FILES=$(git diff --name-only "$BEFORE_SHA" HEAD)
          else
            CHANGED_FILES=$(git ls-files)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          for module_dir in */; do
            module="${module_dir%/}"
            chart_dir="${module}/helm"

            # Skip directories without a helm chart
            if [ ! -f "${chart_dir}/Chart.yaml" ]; then
              continue
            fi

            # Determine if this module's chart version was bumped
            CHART_VERSION=$(yq '.version' "${chart_dir}/Chart.yaml")
            OLD_CHART_VERSION=$(git show "${BEFORE_SHA}:${chart_dir}/Chart.yaml" 2>/dev/null | yq '.version' 2>/dev/null || echo "")
            VERSION_BUMPED=false

            if [ "$OLD_CHART_VERSION" != "$CHART_VERSION" ]; then
              VERSION_BUMPED=true
            fi

            # For workflow_dispatch, always publish
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              VERSION_BUMPED=true
            fi

            if [ "$VERSION_BUMPED" != "true" ]; then
              echo "Skipping ${module}: chart version unchanged (${CHART_VERSION})"
              continue
            fi

            echo "::group::${module} v${CHART_VERSION}"

            # ── Build container images if this module has any ──
            if [ -f "${module}/module.yaml" ]; then
              image_count=$(yq '.images | length' "${module}/module.yaml")
              if [ "$image_count" != "0" ] && [ "$image_count" != "null" ]; then
                for i in $(seq 0 $((image_count - 1))); do
                  image_name=$(yq ".images[${i}].name" "${module}/module.yaml")
                  context=$(yq ".images[${i}].context" "${module}/module.yaml")
                  dockerfile=$(yq ".images[${i}].dockerfile" "${module}/module.yaml")

                  FULL_IMAGE="ghcr.io/${REPO_OWNER}/${image_name}"

                  echo "Building and pushing ${FULL_IMAGE}:${CHART_VERSION}"
                  docker buildx build \
                    --push \
                    -t "${FULL_IMAGE}:${CHART_VERSION}" \
                    -t "${FULL_IMAGE}:latest" \
                    -f "${module}/${dockerfile}" \
                    "${module}/${context}"
                done
              fi
            fi

            # ── Package and publish the Helm chart ──
            chart_name=$(yq '.name' "${chart_dir}/Chart.yaml")

            # Add dependency repos and build
            dep_count=$(yq '.dependencies | length' "${chart_dir}/Chart.yaml")
            if [ "$dep_count" != "null" ] && [ "$dep_count" != "0" ]; then
              for i in $(seq 0 $((dep_count - 1))); do
                dep_repo=$(yq ".dependencies[${i}].repository" "${chart_dir}/Chart.yaml")
                if [ -n "$dep_repo" ] && [ "$dep_repo" != "null" ]; then
                  dep_name="dep-$(echo "$dep_repo" | md5sum | cut -d' ' -f1)"
                  helm repo add "$dep_name" "$dep_repo" 2>/dev/null || true
                fi
              done
              helm dependency build "${chart_dir}"
            fi

            helm package "${chart_dir}" -d .packages

            echo "Pushing ${chart_name}:${CHART_VERSION} to ghcr.io/${REPO_OWNER}/charts..."
            helm push ".packages/${chart_name}-${CHART_VERSION}.tgz" "oci://ghcr.io/${REPO_OWNER}/charts"

            echo "::endgroup::"
          done
