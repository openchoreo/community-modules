# Copyright 2026 The OpenChoreo Authors
# SPDX-License-Identifier: Apache-2.0

openapi: 3.0.3
info:
  title: OpenChoreo Observer API
  description: |
    The OpenChoreo Observer API provides endpoints for querying logs,
    traces, and metrics from namespaces for components, projects, and environments,
    as well as logs from workflows.
    It integrates with separate observability modules to fetch the actual data via
    API calls to the adaptors provided by the modules.
  version: 1.0.0
  contact:
    name: OpenChoreo Team
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

tags:
  - name: Logs
    description: Log retrieval endpoints
  - name: Alerts
    description: Alert rule management endpoints
  - name: Health
    description: Health check endpoints

security:
  - BearerAuth: []

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check the health status of the observer service.
      operationId: health
      security: []
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
        "503":
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: unhealthy
                  error:
                    type: string
                    example: "opensearch: connection failed"

  # Logs query endpoint
  /api/v1/logs/query:
    post:
      tags:
        - Logs
      summary: Query logs
      description: Query logs from the observer service
      operationId: queryLogs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LogsQueryRequest"
      responses:
        "200":
          description: Logs queried successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LogsQueryResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                title: "badRequest"
                errorCode: ""
                message: "Missing required fields 'startTime' and 'endTime'"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                title: "unauthorized"
                errorCode: ""
                message: "Invalid or missing token"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                title: "forbidden"
                errorCode: ""
                message: "Subject <xyz> has no permission to view logs of Namespace foo, Project bar, Component baz in Environment development"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                title: "internalServerError"
                errorCode: "OBS-V1-L-29"
                message: ""

  /api/v1alpha1/alerts/rules:
    post:
      tags:
        - Alerts
      summary: Create alert rule
      description: Create an alert rule in the observer service
      operationId: createAlertRule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AlertRuleRequest"
      responses:
        "200":
          description: Alert rule created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AlertingRuleSyncResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1alpha1/alerts/rules/{ruleName}:
    parameters:
      - name: ruleName
        in: path
        required: true
        description: The name of the alert rule
        schema:
          type: string
    delete:
      tags:
        - Alerts
      summary: Delete alert rule
      description: Delete an alert rule in the observer service
      operationId: deleteAlertRule
      responses:
        "200":
          description: Alert rule deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AlertingRuleSyncResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    # Request schemas for logs
    ComponentSearchScope:
      type: object
      properties:
        namespace:
          type: string
        projectUid:
          type: string
        componentUid:
          type: string
        environmentUid:
          type: string
      required: [namespace]

    WorkflowSearchScope:
      type: object
      properties:
        namespace:
          type: string
        workflowRunName:
          type: string
      required: [namespace]

    LogsQueryRequest:
      type: object
      properties:
        startTime:
          type: string
          description: The start time of the query
          format: date-time
        endTime:
          type: string
          description: The end time of the query
          format: date-time
        limit:
          type: integer
          default: 100
          minimum: 1
          maximum: 1000
          description: The maximum number of items to return
        sortOrder:
          type: string
          description: The sort order of the query
          enum:
            - asc
            - desc
          default: desc
        searchScope:
          oneOf:
            - $ref: "#/components/schemas/ComponentSearchScope"
            - $ref: "#/components/schemas/WorkflowSearchScope"
        logLevels:
          type: array
          uniqueItems: true
          items:
            type: string
            enum: ["DEBUG", "INFO", "WARN", "ERROR"]
        searchPhrase:
          type: string
      required: [startTime, endTime, searchScope]

    # Response schemas for logs
    ComponentLogEntry:
      type: object
      properties:
        timestamp:
          type: string
          description: The timestamp of the log entry
          format: date-time
        log:
          type: string
          description: The log message
        level:
          type: string
          description: The log level
        metadata:
          type: object
          description: The metadata of the log entry
          properties:
            componentName:
              type: string
              description: The OpenChoreo component name that generated the log
            projectName:
              type: string
              description: The OpenChoreo project name that generated the log
            environmentName:
              type: string
              description: The OpenChoreo environment name that generated the log
            namespaceName:
              type: string
              description: The OpenChoreo namespace name that generated the log
            componentUid:
              type: string
              description: The OpenChoreo component UID that generated the log
              format: uuid
            projectUid:
              type: string
              description: The OpenChoreo project UID that generated the log
              format: uuid
            environmentUid:
              type: string
              description: The OpenChoreo environment UID that generated the log
              format: uuid
            containerName:
              type: string
              description: The container name that generated the log
            podName:
              type: string
              description: The Kubernetes pod name that generated the log
            podNamespace:
              type: string
              description: The namespace of the Kubernetes pod that generated the log

    WorkflowLogEntry:
      type: object
      properties:
        timestamp:
          type: string
          description: The timestamp of the log entry
          format: date-time
        log:
          type: string
          description: The log message
        metadata:
          type: object
          description: The metadata of the log entry

    LogsQueryResponse:
      type: object
      properties:
        logs:
          oneOf:
            - type: array
              items:
                $ref: "#/components/schemas/ComponentLogEntry"
            - type: array
              items:
                $ref: "#/components/schemas/WorkflowLogEntry"
          description: The logs queried successfully
        total:
          type: integer
          description: The total number of logs queried
        tookMs:
          type: integer
          description: The time taken to query the logs in milliseconds

    # Request schemas for alert rules
    AlertRuleRequest:
      type: object
      properties:
        metadata:
          type: object
          properties:
            name:
              type: string
              description: The name of the alert rule
            namespace:
              type: string
              description: The namespace of the alert rule CR
            projectUid:
              type: string
              description: The OpenChoreo project UID to query
              format: uuid
            environmentUid:
              type: string
              description: The OpenChoreo environment UID to query
              format: uuid
            componentUid:
              type: string
              description: The OpenChoreo component UID to query
              format: uuid
        source:
          type: object
          properties:
            type:
              type: string
              description: The type of the source
              enum:
                - log
                - metric
            query:
              type: string
              description: The query to execute for log based alerts
            metric:
              type: string
              description: The metric to query for metric based alerts
              enum:
                - cpu_usage
                - memory_usage
        condition:
          type: object
          properties:
            enabled:
              type: boolean
              description: Whether the alert rule is enabled
            window:
              type: string
              description: The window of time to query for the alert rule
            interval:
              type: string
              description: The interval of time to query for the alert rule
            operator:
              type: string
              description: The operator to use for the alert rule
              enum:
                - gt
                - gte
                - lt
                - lte
                - eq
                - neq
            threshold:
              type: number
              description: The threshold value to use for the alert rule

    # Response schemas for alert rules
    AlertingRuleSyncResponse:
      type: object
      properties:
        action:
          type: string
          description: The action taken on the alert rule
          enum:
            - created
            - updated
            - deleted
        lastSyncedAt:
          type: string
          description: The timestamp of the last sync
        status:
          type: string
          description: The status of the alert rule
          enum:
            - synced
            - failed
        ruleLogicalId:
          type: string
          description: The logical ID (name) of the alert rule
        ruleBackendId:
          type: string
          description: The backend ID (UID from observability backend) of the alert rule

    # New error response schema
    ErrorResponse:
      type: object
      properties:
        title:
          type: string
          description: The error message
          enum:
            - badRequest
            - unauthorized
            - forbidden
            - notFound
            - internalServerError
        errorCode:
          type: string
          description: The error code from observer service
          example: OBS-V1-L-22
        message:
          type: string
          description: Human-readable error message
          example: "Missing required fields 'startTime' and 'endTime'"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authentication. Include the token in the Authorization header as 'Bearer <token>'.
